<html>
	<head>
		<meta charset="utf-8"/>
		<title>Stellar'ISEN</title>
		<link rel="stylesheet" type="text/css" href="css/style.css">
		<script src="https://cdnjs.cloudflare.com/ajax/libs/tween.js/17.2.0/Tween.js"> </script>
		<script src="https://cdnjs.cloudflare.com/ajax/libs/nosleep/0.6.0/NoSleep.js"> </script>
		<script src="js/three.js"></script>
		<script src="js/utils.js"></script>
		<script src="js/DeviceOrientationControls.js"></script>
		<script src="js/skymap.js"></script>
		<script src="js/Star.js"></script>
		<script src="js/Link.js"></script>
		<script src="js/Constellation.js"></script>
		<script src="js/Visor.js"></script>
		<script src="js/planets.js"></script>
		<script src="js/Planet.js"></script>
	</head>
	<body>
		<div id="ui">
			<div id="header">
				<img src="res/images/astronaut.png" alt="User" id="userImage"/>
				<input id="searchField" type="text" placeholder="Rechercher..."/>
			</div>
			<div id="whitespace"></div>
			<div id="footer">
				<button class="nephritis-flat-button" onmousedown="event.stopPropagation();" onmouseup="event.stopPropagation(); switchScene();">Système solaire</button>
			</div>
		</div>

		<div id="loader-wrapper">
			<img id="loader" src="res/images/planet.png" alt="">
		</div>

		<script>
			var noSleep = new NoSleep();
			noSleep.enable();

			var skyScene = new THREE.Scene();
			var planetsScene = new THREE.Scene();
			var camera = null;
			var scene = null;
			var renderer = new THREE.WebGLRenderer({ antialias: true });

			window.onhashchange = () => { updateHash(false); };

			let skySphere = new SkySphere(skyScene, camera, renderer, onLoad);
			let planets = new Planets(planetsScene, camera, renderer, onLoad);

			let sceneUpdate = null;
			let home = true;

			function switchScene() {
				showLoading();
				setTimeout(function() {
					if (home) {
						camera = planets.camera;
						scene = planetsScene;
						sceneUpdate = () => { planets.update() };
						home = false;
					}
					else {
						camera = skySphere.camera;
						scene = skyScene;
						sceneUpdate = () => { skySphere.update() };
						home = true;
					}
					hideLoading();
				}, 1000);
			}

			function onLoad() {
				if (skySphere.loaded && planets.loaded) {
					let hash = window.location.hash.substring(1);

					if (hash != '') {
						updateHash(true);
					}
					else {
						// Initialisation à la page principale (skysphere)
						camera = skySphere.camera;
						scene = skyScene;
						sceneUpdate = () => { skySphere.update() };
					}

					hideLoading();

					var update = () => {
						requestAnimationFrame(update);
						TWEEN.update();
						sceneUpdate();
						renderer.render(scene, camera);
					};
					update();
				}
			}

			function updateHash(starting) {
				let hash = window.location.hash.substring(1);
				let star = null;
				let planet = null;

				if (hash == "SystemeSolaire") {
					//planets.rearrange();
					home = false;
					camera = planets.camera;
					scene = planetsScene;
					sceneUpdate = () => { planets.update() };
					//camera.position.x = 0;
					planets.lookAtAll();
					return;
				}

				for (let i = 0; i < skySphere.starsObjects.length; i++) {
					if (hash == skySphere.starsObjects[i].meshName) {
						star = skySphere.starsObjects[i];
					}
				}

				for (let i = 0; i < planets.planets.length; i++) {
					if (hash == planets.planets[i].name) {
						planet = planets.planets[i];
					}
				}

				if (star != null && planet != null) {
					console.log("Excuse me what the fuck ?");
					window.location.replace("https://huit.re/PHJa91WW");
				}

				if (planet != null) {
					if (starting) {
						home = false;
						camera = planets.camera;
						scene = planetsScene;
						sceneUpdate = () => { planets.update() };
					}
					if (home) {
						showLoading();
						setTimeout(function() {
							// Initialisation à la page des planetes
							home = false;
							camera = planets.camera;
							scene = planetsScene;
							sceneUpdate = () => { planets.update() };
							hideLoading();
							planets.lookAtPlanet(planet);
						}, 1000);
					}
					else {
						planets.lookAtPlanet(planet);
					}
					// Ici on va mettre tout ce qui est changement de planète
				}
				else {
					if (starting) {
						camera = skySphere.camera;
						scene = skyScene;
						sceneUpdate = () => { skySphere.update() };
					}
					else {
						// Si on est pas sur l'écran des étoiles, on montre le loading
						if (!home) {
							showLoading();
							setTimeout(function() {
								camera = skySphere.camera;
								scene = skyScene;
								home = true;
								sceneUpdate = () => { skySphere.update() };
								hideLoading();

								/* Une fois le loading fini, on bouge la caméra vers l'étoile */
								if (star != null) {
									skySphere.lookAtStar(star);
								}
							}, 1000);
						}
					}

					/* Si on est déjà sur l'écran des étoiles, on bouge la caméra */
					if (home) {
						if (star != null) {
							skySphere.lookAtStar(star);
						}
					}

				}
			}

			function hideLoading() {
				/* Activation de l'animation de fade-out du loading */
				const loadingScreen = document.getElementById( 'loader-wrapper' );
				loadingScreen.classList.remove( 'fade-in' );
				loadingScreen.classList.add( 'fade-out' );
			}

			function showLoading() {
				/* Activation de l'animation de fade-out du loading */
				const loadingScreen = document.getElementById( 'loader-wrapper' );
				loadingScreen.classList.remove( 'fade-out' );
				loadingScreen.classList.add('fade-in');
			}
		</script>
	</body>
</html>
