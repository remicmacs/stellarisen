<html>
	<head>
		<meta charset="utf-8"/>
		<!--<meta name="viewport" content="width=device-width, initial-scale=1.0">-->
		<meta name="viewport" content="user-scalable=no, initial-scale=1.0, maximum-scale=1.0" />
		<title>Stellar'ISEN</title>
		<link rel="stylesheet" type="text/css" href="css/style.css">
		<script src="https://cdnjs.cloudflare.com/ajax/libs/tween.js/17.2.0/Tween.min.js"> </script>
		<!--<script src="https://cdnjs.cloudflare.com/ajax/libs/nosleep/0.6.0/NoSleep.js"> </script>-->
		<script src="js/three.js"></script>
		<script src="js/utils.js"></script>
		<script src="js/DeviceOrientationControls.js"></script>
		<script src="js/skymap.js"></script>
		<script src="js/Star.js"></script>
		<script src="js/Link.js"></script>
		<script src="js/Constellation.js"></script>
		<script src="js/Visor.js"></script>
		<script src="js/planets.js"></script>
		<script src="js/Planet.js"></script>
	</head>
	<body>

		<div id="ui">

			<div id="header">
				<img src="res/images/astronaut.png" alt="User" id="userImage"/>
				<input id="searchField" type="text" placeholder="Rechercher..."/>
			</div>

			<div id="footer">

			</div>

		</div>

		<div class="light disabled modal" id="menu">

			<div class="list">

				<div class="list-header">
					<div class="list-name">Anonyme</div>
					<div id="close-menu" class="close">&times;</div>
				</div>

				<button id="scene-switch" class="nephritis-flat-button list-button">Système solaire</button>
				<button class="list-button">Connexion</button>
				<button class="list-button">Création de compte</button>
				<button class="list-button">À propos</button>

			</div>

		</div>

		<!-- Modal dialog pour les infos d'étoiles -->

		<div class="wrapper center disabled" id="infos-wrapper">
			<div class="light disabled modal center" id="infos">
				<div class="list">

					<div class="infos-header">
						<h1 id="objectName"></h1>
						<div id="close-infos" class="close">&times;</div>
					</div>

					<div class="line">
						<img src="https://placehold.jp/150x150.png" id="star-picture"/>

						<div class="column">
							<div>
								Appartient à la constellation de <span id="con-name"></span>
							</div>

							<div>
								Se situe à une distance de <span id="star-distance"></span> année-lumières
							</div>
						</div>

					</div>

				</div>
			</div>
		</div>

		<!-- Modal dialog pour les infos de planètes -->

		<div class="wrapper right disabled" id="planet-infos-wrapper">
			<div class="light disabled modal right" id="planet-infos">
				<div class="list">

					<div class="infos-header">
						<h1 id="planetName"></h1>
						<div id="close-pinfos" class="close">&times;</div>
					</div>

				</div>
			</div>
		</div>

		<div id="loader-wrapper" class="wrapper center">
			<img id="loader" src="res/images/planet.png" alt="">
		</div>

		<script>
			//var noSleep = new NoSleep();
			//noSleep.enable();

			var skyScene = new THREE.Scene();
			var planetsScene = new THREE.Scene();
			var camera = null;
			var scene = null;
			var renderer = new THREE.WebGLRenderer({ antialias: true });

			window.onhashchange = () => { updateHash(false); };

			let skySphere = new SkySphere(skyScene, camera, renderer, onLoad);
			let planets = new Planets(planetsScene, camera, renderer, onLoad);

			let sceneUpdate = null;
			let home = true;

			let previousHash = null;

			renderer.setPixelRatio(window.devicePixelRatio);
			renderer.setSize(window.innerWidth, window.innerHeight);
			document.body.appendChild(renderer.domElement);

			document.addEventListener('mousemove', onMove);
			document.addEventListener('mousedown', onMouseDown);
			document.addEventListener('mouseup', onMouseUp);
			document.addEventListener('touchstart', onTouchStart);
			document.addEventListener('touchend', onTouchEnd);

			events =
				[	[	'userImage'			,	'mouseup'		,	openMenu												]
				,	[	'userImage'			,	'touchend'	,	openMenu												]
				,	[	'userImage'			,	'mousedown'	,	(e) => { e.stopPropagation(); }	]
				,	[	'userImage'			,	'touchstart',	(e) => { e.stopPropagation(); }	]
				,	[	'close-menu'		,	'mouseup'		,	closeMenu												]
				,	[	'close-menu'		,	'touchend'	,	closeMenu												]
				,	[	'close-menu'		,	'mousedown'	,	(e) => { e.stopPropagation(); }	]
				,	[	'close-menu'		,	'touchstart',	(e) => { e.stopPropagation(); }	]
				,	[	'close-infos'		,	'mouseup'		,	closeInfos											]
				,	[	'close-infos'		,	'touchend'	,	closeInfos											]
				,	[	'close-infos'		,	'mousedown'	,	(e) => { e.stopPropagation(); }	]
				,	[	'close-infos'		,	'touchstart',	(e) => { e.stopPropagation(); }	]
				,	[	'close-pinfos'	,	'mouseup'		,	closePInfos											]
				,	[	'close-pinfos'	,	'touchend'	,	closePInfos											]
				,	[	'close-pinfos'	,	'mousedown'	,	(e) => { e.stopPropagation(); }	]
				,	[	'close-pinfos'	,	'touchstart',	(e) => { e.stopPropagation(); }	]
				,	[	'scene-switch'	,	'mouseup'		,	switchHash											]
				,	[	'scene-switch'	,	'touchend'	,	switchHash											]
				,	[	'scene-switch'	,	'mousedown'	,	(e) => { e.stopPropagation(); }	]
				,	[	'scene-switch'	,	'touchstart',	(e) => { e.stopPropagation(); }	]
				,	[	'infos-wrapper'	,	'mouseup'		,	(e) => { e.stopPropagation(); }	]
				,	[	'infos-wrapper'	,	'touchend'	,	(e) => { e.stopPropagation(); }	]
				,	[	'infos-wrapper'	,	'mousedown'	,	(e) => { e.stopPropagation(); }	]
				,	[	'infos-wrapper'	,	'touchstart',	(e) => { e.stopPropagation(); }	]
				,	[	'planet-infos'	,	'mouseup'		,	(e) => { e.stopPropagation(); }	]
				,	[	'planet-infos'	,	'touchend'	,	(e) => { e.stopPropagation(); }	]
				,	[	'planet-infos'	,	'mousedown'	,	(e) => { e.stopPropagation(); }	]
				,	[	'planet-infos'	,	'touchstart',	(e) => { e.stopPropagation(); }	]
				,	[	'con-name'			,	'click'			,	(e) => {  }	]
				]

			for (let i = 0; i < events.length; i++) {
				document.getElementById(events[i][0]).addEventListener
					(	events[i][1]
					,	events[i][2]
					);
			}

			function switchScene() {
				showLoading();
				setTimeout(function() {
					if (home) {
						camera = planets.camera;
						scene = planetsScene;
						sceneUpdate = () => { planets.update() };
						home = false;
						planets.lookAtAll();
					}
					else {
						camera = skySphere.camera;
						scene = skyScene;
						sceneUpdate = () => { skySphere.update() };
						home = true;
					}
					hideLoading();
				}, 1000);
			}

			function onLoad() {
				if (skySphere.loaded && planets.loaded) {
					let hash = window.location.hash.substring(1);
					previousHash = hash;

					if (hash != '') {
						updateHash(true);
					}
					else {
						// Initialisation à la page principale (skysphere)
						camera = skySphere.camera;
						scene = skyScene;
						sceneUpdate = () => { skySphere.update() };
					}

					hideLoading();

					var update = () => {
						requestAnimationFrame(update);
						TWEEN.update();
						sceneUpdate();
						renderer.render(scene, camera);
					};
					update();
				}
			}

			function updateHash(starting) {
				let splinters = window.location.hash.substring(1).split("-");
				let hash = decodeURI(splinters[0]);
				let state = (splinters.length > 1 ? splinters[1] : null);
				let star = null;
				let planet = null;

				/* Si on entre "SystemeSolaire" et qu'il faut changer de scène */
				if (hash == "SystemeSolaire" && scene == skyScene) {
					switchScene();
					return;
				}
				/* Si on entre dans "Etoiles" et qu'il faut changer de scène */
				else if (hash == "Etoiles" && scene == planetsScene) {
					switchScene();
					return;
				}
				/* Si on veut juste aller à l'ensemble du système solaire */
				else if (hash == "SystemeSolaire") {
					home = false;
					camera = planets.camera;
					scene = planetsScene;
					sceneUpdate = () => { planets.update() };
					planets.lookAtAll();
					return;
				}
				/* Si on veut juste aller à l'ensemble des étoiles */
				else if (hash == "Etoiles") {
					home = true;
					camera = skySphere.camera;
					scene = skyScene;
					sceneUpdate = () => { skySphere.update() };
					skySphere.rearrange();
					return;
				}

				for (let i = 0; i < skySphere.starsObjects.length; i++) {
					if (hash == skySphere.starsObjects[i].meshName) {
						star = skySphere.starsObjects[i];
					}
				}

				for (let i = 0; i < planets.planets.length; i++) {
					if (hash == planets.planets[i].name) {
						planet = planets.planets[i];
					}
				}

				previousHash == hash;

				if (star != null && planet != null) {
					console.log("Excuse me what the fuck ?");
					window.location.replace("https://huit.re/PHJa91WW");
				}

				if (planet != null) {
					if (starting) {
						home = false;
						camera = planets.camera;
						scene = planetsScene;
						sceneUpdate = () => { planets.update() };
					}
					if (state != null && state == "open") {
						enable('planet-infos-wrapper');
						enable('planet-infos');
					}
					if (state == null) {
						disable('planet-infos-wrapper');
						disable('planet-infos');
					}
					if (home) {
						showLoading();
						setTimeout(function() {
							// Initialisation à la page des planetes
							home = false;
							camera = planets.camera;
							scene = planetsScene;
							sceneUpdate = () => { planets.update() };
							hideLoading();
							planets.lookAtPlanet(planet);
						}, 1000);
					}
					else {
						planets.lookAtPlanet(planet);
					}
					// Ici on va mettre tout ce qui est changement de planète
				}
				else {
					if (starting) {
						camera = skySphere.camera;
						scene = skyScene;
						sceneUpdate = () => { skySphere.update() };
					}
					else {
						if (state != null && state == "open") {
							enable('infos-wrapper');
							enable('infos');
						}
						if (state == null) {
							disable('infos-wrapper');
							disable('infos');
						}
						// Si on est pas sur l'écran des étoiles, on montre le loading
						if (!home) {
							showLoading();
							setTimeout(function() {
								camera = skySphere.camera;
								scene = skyScene;
								home = true;
								sceneUpdate = () => { skySphere.update() };
								hideLoading();

								/* Une fois le loading fini, on bouge la caméra vers l'étoile */
								if (star != null) {
									skySphere.lookAtStar(star);
								}
							}, 1000);
						}
					}

					/* Si on est déjà sur l'écran des étoiles, on bouge la caméra */
					if (home) {
						if (star != null) {
							skySphere.lookAtStar(star);
						}
					}

				}
			}

			function hideLoading() {
				/* Activation de l'animation de fade-out du loading */
				const loadingScreen = document.getElementById( 'loader-wrapper' );
				loadingScreen.classList.remove( 'fade-in' );
				loadingScreen.classList.add( 'fade-out' );
			}

			function showLoading() {
				/* Activation de l'animation de fade-out du loading */
				const loadingScreen = document.getElementById( 'loader-wrapper' );
				loadingScreen.classList.remove( 'fade-out' );
				loadingScreen.classList.add('fade-in');
			}

			function onMove(event) {
				if (home) {
					skySphere.onMove(event);
				}
				else {
					planets.onMove(event);
				}
			}

			function onMouseDown(event) {
				if (home) {
					skySphere.onMouseDown();
				}
				else {
					planets.onMouseDown(event);
				}
			}

			function onMouseUp(event) {
				if (home) {
					skySphere.onMouseUp(event);
				}
				else {
					planets.onMouseUp(event);
				}
			}

			function onTouchStart(event) {
				if (home) {
					skySphere.onTouchStart();
				}
				else {
					planets.onTouchStart(event);
				}
			}

			function onTouchEnd(event) {
				if (home) {
					skySphere.onTouchEnd(event);
				}
				else {
					planets.onTouchEnd(event);
				}
			}

			function openMenu(event) {
				event.stopPropagation();
				enable('menu');
			}

			function closeMenu(event) {
				event.stopPropagation();
				disable('menu');
			}

			function closeInfos(event) {
				event.stopPropagation();
				window.history.back();
			}

			function closePInfos(event) {
				event.stopPropagation();
				window.history.back();
			}

			function switchHash(event) {
				event.stopPropagation();
				disable('menu');
				if (scene == skyScene) {
					window.location.hash='#SystemeSolaire';
				}
				else {
					window.location.hash='#Etoiles';
				}
			}
		</script>
	</body>
</html>
